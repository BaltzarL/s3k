name: Build RISC-V GCC Toolchain

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          sudo apt update
          sudo apt install -y \
            autoconf automake autotools-dev curl python3 \
            libmpc-dev libmpfr-dev libgmp-dev gawk build-essential \
            bison flex texinfo gperf libtool patchutils bc zlib1g-dev \
            libexpat-dev

      - name: Clone riscv-gnu-toolchain
        run: |
          mkdir RISCV
          cd RISCV
          git clone --recursive https://github.com/riscv/riscv-gnu-toolchain
          cd riscv-gnu-toolchain

      - name: Configure build for rv64gcv / lp64d
        run: |
          cd RISCV/riscv-gnu-toolchain
          mkdir build
          cd build
          ../configure --prefix=/opt/riscv --with-arch=rv64gcv --with-abi=lp64d

      - name: Build and install
        run: |
          cd RISCV/riscv-gnu-toolchain/build
          sudo make -j$(nproc)
          # Optionally: sudo make install
          
      - name: Add toolchain to PATH (for subsequent steps)
        run: |
          echo "/opt/riscv/bin" >> $GITHUB_PATH

      - name: Test compile minimal C program
        run: |
          cat > example.c << 'EOF'
          #include <stdio.h>
          int main(void) {
            printf("Hello RISC-V\\n");
            return 0;
          }
          EOF
          riscv64-unknown-elf-gcc -march=rv64gcv071 -o example example.c
          file example
