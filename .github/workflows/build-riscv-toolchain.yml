name: Build RISC-V GCC Toolchain

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache riscv-gnu-toolchain sources
        id: cache-src
        uses: actions/cache@v4
        with:
          path: riscv-gnu-toolchain
          key: riscv-toolchain-src-${{ hashFiles('**/riscv-toolchain-version.txt') }}
          restore-keys: |
            riscv-toolchain-src-

      # Skip cloning if source is already cached
      - name: Checkout riscv-gnu-toolchain if not cached
        if: steps.cache-src.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          repository: riscv-collab/riscv-gnu-toolchain
          path: riscv-gnu-toolchain
          #submodules: recursive

      # Cache the build directory
      - name: Cache build directory
        id: cache-build
        uses: actions/cache@v4
        with:
          path: riscv-gnu-toolchain/build
          key: riscv-toolchain-build-${{ runner.os }}-${{ hashFiles('**/riscv-toolchain-version.txt') }}
          restore-keys: |
            riscv-toolchain-build-${{ runner.os }}-

      # Configure the build
      - name: Configure build
        run: |
          mkdir -p riscv-gnu-toolchain/build
          cd riscv-gnu-toolchain/build
          ../configure --prefix=$HOME/riscv --with-arch=rv64gcv --with-abi=lp64d

      # Build the toolchain
      - name: Build toolchain
        run: |
          cd riscv-gnu-toolchain/build
          make -j$(nproc)

      # Add the toolchain to PATH for subsequent steps
      - name: Add toolchain to PATH
        run: echo "$HOME/riscv/bin" >> $GITHUB_PATH

      # Test compiling a simple RISC-V program
      - name: Test compile a simple RISC-V program
        run: |
          cat > example.c << 'EOF'
          #include <stdio.h>
          int main(void) {
              printf("Hello, RISC-V!\\n");
              return 0;
          }
          EOF
          riscv64-unknown-elf-gcc -march=rv64gcv071 -o example example.c
          file example
